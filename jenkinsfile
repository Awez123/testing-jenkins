pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    purpose: eks-auth-check
spec:
  serviceAccountName: jenkins
  containers:
  - name: aws-tools
    image: jerinpaul/awscli-helm-kubectl:latest
    command: ['cat']
    tty: true
    resources:
      limits:
        memory: "1Gi"
        cpu: "1000m"
      requests:
        memory: "512Mi"
        cpu: "500m"
  restartPolicy: Never
"""
            defaultContainer 'aws-tools'
        }
    }

    environment {
        AWS_REGION = 'ap-south-1'
        CLUSTER_NAME = 'hh-stg-eks'
    }

    stages {
        stage('Check AWS Access & Kubeconfig') {
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'jenkinsuser']]) {
                    sh '''
                        echo "üîê Authenticating with AWS..."
                        aws sts get-caller-identity

                        echo "üìã Listing EKS clusters..."
                        aws eks list-clusters --region ${AWS_REGION}

                        echo "üîß Setting kubeconfig for EKS cluster: ${CLUSTER_NAME}"
                        aws eks update-kubeconfig --region ${AWS_REGION} --name ${CLUSTER_NAME}

                        echo "‚úÖ Current kubectl context:"
                        kubectl config current-context

                        echo "üì° Getting cluster nodes:"
                        kubectl get nodes
                    '''
                }
            }
        }
    }

    post {
        always {
            echo currentBuild.result == 'SUCCESS' ? "‚úÖ Pipeline completed successfully!" : "‚ùå Pipeline failed. Check logs."
        }
    }
}
